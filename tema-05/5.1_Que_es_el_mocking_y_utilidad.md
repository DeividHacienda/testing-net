# 5.1 Qué es el mocking y utilidad

## ¿Qué es el mocking?

El **mocking** es una técnica de testing que permite crear objetos simulados (mocks) que imitan el comportamiento de objetos reales. Estos objetos falsos se utilizan para aislar la unidad de código que estamos probando de sus dependencias externas.

## ¿Por qué es importante?

### Aislamiento de dependencias
Cuando probamos una clase que depende de servicios externos (bases de datos, APIs, sistemas de archivos), no queremos que nuestras pruebas fallen por problemas ajenos al código que estamos testeando.

### Ventajas del mocking

- **Control total**: Definimos exactamente qué devuelven las dependencias
- **Rapidez**: Las pruebas no acceden a recursos externos lentos
- **Repetibilidad**: Los resultados son consistentes y predecibles
- **Independencia**: Las pruebas no dependen de infraestructura externa

## Ejemplo sin mocking (problemático)

```csharp
public class PedidoService
{
    private readonly BaseDatosRepository _repository;
    
    public PedidoService()
    {
        _repository = new BaseDatosRepository(); // Dependencia directa
    }
    
    public bool ProcesarPedido(int pedidoId)
    {
        var pedido = _repository.ObtenerPedido(pedidoId);
        // Lógica de negocio
        return pedido != null && pedido.Total > 0;
    }
}

// Problema: La prueba requiere una base de datos real
[TestMethod]
public void ProcesarPedido_ConPedidoValido_RetornaTrue()
{
    var service = new PedidoService(); // ¡Necesita BD!
    var resultado = service.ProcesarPedido(1);
    Assert.IsTrue(resultado);
}
```

## Ejemplo con mocking (correcto)

```csharp
public class PedidoService
{
    private readonly IBaseDatosRepository _repository;
    
    // Inyección de dependencias
    public PedidoService(IBaseDatosRepository repository)
    {
        _repository = repository;
    }
    
    public bool ProcesarPedido(int pedidoId)
    {
        var pedido = _repository.ObtenerPedido(pedidoId);
        return pedido != null && pedido.Total > 0;
    }
}

// Prueba aislada con mock
[TestMethod]
public void ProcesarPedido_ConPedidoValido_RetornaTrue()
{
    // Arrange: Creamos un mock del repository
    var mockRepository = new Mock<IBaseDatosRepository>();
    mockRepository.Setup(r => r.ObtenerPedido(1))
        .Returns(new Pedido { Id = 1, Total = 100 });
    
    var service = new PedidoService(mockRepository.Object);
    
    // Act
    var resultado = service.ProcesarPedido(1);
    
    // Assert
    Assert.IsTrue(resultado);
}
```

## Tipos de objetos de prueba

### Mock
Objeto que verifica que se llamaron ciertos métodos con parámetros específicos.

### Stub
Objeto que devuelve valores predefinidos sin verificar llamadas.

### Fake
Implementación simplificada funcional (ej: BD en memoria).

### Spy
Objeto que registra información sobre cómo fue usado.

## Cuándo usar mocking

✅ **Usar mocking cuando**:
- La dependencia accede a recursos externos (BD, API, archivos)
- La dependencia es lenta o costosa
- Necesitas simular errores o casos extremos
- Quieres verificar interacciones entre objetos

❌ **No usar mocking cuando**:
- Estás probando lógica simple sin dependencias
- La dependencia es trivial (ej: clases POCO)
- Estás haciendo pruebas de integración
- El mock es más complejo que la implementación real

## Principios clave

1. **Mock las interfaces, no las implementaciones**
2. **No mockees lo que no posees** (librerías de terceros)
3. **Mantén los mocks simples**: Si el setup es muy complejo, revisa tu diseño
4. **Un test, un comportamiento**: No uses el mismo mock para múltiples escenarios

## Requisitos previos

Para usar mocking efectivamente en .NET 4.8:
- Aplicar **Inyección de Dependencias**
- Programar contra **Interfaces** (Dependency Inversion Principle)
- Mantener clases con **responsabilidad única** (Single Responsibility Principle)
